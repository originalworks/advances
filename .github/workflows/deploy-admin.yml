name: "Deploy Admin Panel template"

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
    secrets:
      IAM_WORKFLOW_ROLE:
        required: true

permissions:
  id-token: write
  contents: read
  packages: read

jobs:
  deploy-admin:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@originalworks'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.IAM_WORKFLOW_ROLE }}
          role-duration-seconds: 1200

      - name: Fetch SSM Parameters
        run: |
          set -e

          ENV="${{ inputs.environment }}"

          # Define parameter paths ONCE
          AUTH0_ISSUER_PATH="/ow/$ENV/auth0/issuer"
          AUTH0_AUDIENCE_PATH="/ow/$ENV/auth0/audience"
          AUTH0_CLIENT_ID_PATH="/ow/$ENV/auth0/client-id"
          BACKEND_URL_PATH="/ow/$ENV/advances/backend_url"
          ADMIN_S3_BUCKET_PATH="/ow/$ENV/admin/bucket-name"
          DISTRIBUTION_ID_PATH="/ow/$ENV/admin/distribution-id"
          BASE_RPC_URL_PATH="/ow/$ENV/admin/base-rpc-url"
          BASE_SUBGRAPH_URL_PATH="/ow/$ENV/admin/base-subgraph-url"
          POLYGON_RPC_URL_PATH="/ow/$ENV/admin/polygon-rpc-url"
          POLYGON_SUBGRAPH_URL_PATH="/ow/$ENV/admin/polygon-subgraph-url"

          # Fetch all parameters in one call
          PARAMS=$(aws ssm get-parameters \
            --names \
              "$AUTH0_ISSUER_PATH" \
              "$AUTH0_AUDIENCE_PATH" \
              "$AUTH0_CLIENT_ID_PATH" \
              "$BACKEND_URL_PATH" \
              "$ADMIN_S3_BUCKET_PATH" \
              "$DISTRIBUTION_ID_PATH" \
              "$BASE_RPC_URL_PATH" \
              "$BASE_SUBGRAPH_URL_PATH" \
              "$POLYGON_RPC_URL_PATH" \
              "$POLYGON_SUBGRAPH_URL_PATH" \
            --with-decryption)

          # Extract values using the defined paths
          AUTH0_ISSUER=$(echo "$PARAMS" | jq -r ".Parameters[] | select(.Name==\"$AUTH0_ISSUER_PATH\") | .Value")
          AUTH0_AUDIENCE=$(echo "$PARAMS" | jq -r ".Parameters[] | select(.Name==\"$AUTH0_AUDIENCE_PATH\") | .Value")
          AUTH0_CLIENT_ID=$(echo "$PARAMS" | jq -r ".Parameters[] | select(.Name==\"$AUTH0_CLIENT_ID_PATH\") | .Value")
          BACKEND_URL=$(echo "$PARAMS" | jq -r ".Parameters[] | select(.Name==\"$BACKEND_URL_PATH\") | .Value")
          ADMIN_S3_BUCKET=$(echo "$PARAMS" | jq -r ".Parameters[] | select(.Name==\"$ADMIN_S3_BUCKET_PATH\") | .Value")
          DISTRIBUTION_ID=$(echo "$PARAMS" | jq -r ".Parameters[] | select(.Name==\"$DISTRIBUTION_ID_PATH\") | .Value")
          BASE_RPC_URL=$(echo "$PARAMS" | jq -r ".Parameters[] | select(.Name==\"$BASE_RPC_URL_PATH\") | .Value")
          BASE_SUBGRAPH_URL=$(echo "$PARAMS" | jq -r ".Parameters[] | select(.Name==\"$BASE_SUBGRAPH_URL_PATH\") | .Value")
          POLYGON_RPC_URL=$(echo "$PARAMS" | jq -r ".Parameters[] | select(.Name==\"$POLYGON_RPC_URL_PATH\") | .Value")
          POLYGON_SUBGRAPH_URL=$(echo "$PARAMS" | jq -r ".Parameters[] | select(.Name==\"$POLYGON_SUBGRAPH_URL_PATH\") | .Value")

          # Fail fast if any parameter missing
          for VAR in AUTH0_ISSUER AUTH0_AUDIENCE AUTH0_CLIENT_ID BACKEND_URL ADMIN_S3_BUCKET DISTRIBUTION_ID BASE_RPC_URL BASE_SUBGRAPH_URL POLYGON_RPC_URL POLYGON_SUBGRAPH_URL
          do
            if [ -z "${!VAR}" ]; then
              echo "Missing SSM parameter: $VAR"
              exit 1
            fi
          done

          # Export to GitHub env
          echo "AUTH0_ISSUER=$AUTH0_ISSUER" >> $GITHUB_ENV
          echo "AUTH0_AUDIENCE=$AUTH0_AUDIENCE" >> $GITHUB_ENV
          echo "AUTH0_CLIENT_ID=$AUTH0_CLIENT_ID" >> $GITHUB_ENV
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_ENV
          echo "ADMIN_S3_BUCKET=$ADMIN_S3_BUCKET" >> $GITHUB_ENV
          echo "DISTRIBUTION_ID=$DISTRIBUTION_ID" >> $GITHUB_ENV
          echo "BASE_RPC_URL=$BASE_RPC_URL" >> $GITHUB_ENV
          echo "BASE_SUBGRAPH_URL=$BASE_SUBGRAPH_URL" >> $GITHUB_ENV
          echo "POLYGON_RPC_URL=$POLYGON_RPC_URL" >> $GITHUB_ENV
          echo "POLYGON_SUBGRAPH_URL=$POLYGON_SUBGRAPH_URL" >> $GITHUB_ENV

      - name: Install dependencies
        run: npm ci
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build frontend
        env:
          NX_CLOUD_ENABLED: 'false'
          VITE_ENVIRONMENT: ${{ inputs.environment }}
          VITE_AUTH0_ISSUER: ${{ env.AUTH0_ISSUER }}
          VITE_AUTH0_AUDIENCE: ${{ env.AUTH0_AUDIENCE }}
          VITE_AUTH0_CLIENT_ID: ${{ env.AUTH0_CLIENT_ID }}
          VITE_BACKEND_URL: ${{ env.BACKEND_URL }}
          VITE_BASE_RPC_URL: ${{ env.BASE_RPC_URL }}
          VITE_BASE_SUBGRAPH_URL: ${{ env.BASE_SUBGRAPH_URL }}
          VITE_POLYGON_RPC_URL: ${{ env.POLYGON_RPC_URL }}
          VITE_POLYGON_SUBGRAPH_URL: ${{ env.POLYGON_SUBGRAPH_URL }}
          VITE_PROD_DOMAIN: ${{ secrets.PROD_DOMAIN }}
          VITE_STAGE_DOMAIN: ${{ secrets.STAGE_DOMAIN }}
        run: npx nx run admin:build --no-cloud

      - name: Deploy to S3
        run: |
          aws s3 sync apps/admin/dist s3://${{ env.ADMIN_S3_BUCKET }} --delete

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ env.DISTRIBUTION_ID }} \
            --paths "/*"